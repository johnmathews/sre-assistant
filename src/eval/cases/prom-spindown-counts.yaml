id: prom-spindown-counts
description: "Agent should query the disk:spindown_event:1 recording rule for HDD spindown counts"
question: "How many times did the HDDs spin down in the last 24 hours?"

required_services: []

expected_tools:
  must_call: [prometheus_instant_query]
  may_call: [prometheus_search_metrics, runbook_search, hdd_power_status]
  must_not_call: []

mocks:
  - url: "http://prometheus.test:9090/api/v1/query"
    method: GET
    status: 200
    body:
      status: "success"
      data:
        resultType: "vector"
        result:
          - metric:
              hostname: "truenas"
              disk_id: "wwn-0x5000c500eb02b449"
            value: [1705312800, "3"]
          - metric:
              hostname: "truenas"
              disk_id: "wwn-0x5000c500eb19921b"
            value: [1705312800, "3"]
          - metric:
              hostname: "truenas"
              disk_id: "wwn-0x5000c500f7425581"
            value: [1705312800, "1"]
          - metric:
              hostname: "truenas"
              disk_id: "wwn-0x5000c500f742ccbf"
            value: [1705312800, "1"]
          - metric:
              hostname: "proxmox"
              disk_id: "wwn-0x5000c500b466dcfc"
            value: [1705312800, "2"]
  - url: "http://prometheus.test:9090/api/v1/metadata"
    method: GET
    status: 200
    body:
      status: "success"
      data:
        disk:spindown_event:1:
          - type: "gauge"
            help: "HDD spindown event recording rule"
            unit: ""
  - url: "http://grafana.test:3000/api/alertmanager/grafana/api/v2/alerts/groups"
    method: GET
    status: 200
    body: []

rubric: |
  The answer should:
  1. Report spindown counts per disk over the last 24 hours
  2. Show that the tank disks (truenas) spun down 3 times each
  3. Show that the backup disks spun down 1 time each
  4. Show that the proxmox backup disk spun down 2 times
  5. Use sum_over_time with the disk:spindown_event:1 recording rule, or use hdd_power_status
