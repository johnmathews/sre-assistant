id: prom-adguard-dns
description: "Agent should query AdGuard DNS metrics for query rates per client"
question: "Show me a breakdown of DNS queries by device. Which device is making the most?"

required_services: []

expected_tools:
  must_call: [prometheus_instant_query]
  may_call: []
  must_not_call: [grafana_get_alerts]

mocks:
  - url: "http://prometheus.test:9090/api/v1/query"
    method: GET
    status: 200
    body:
      status: "success"
      data:
        resultType: "vector"
        result:
          - metric:
              __name__: "adguard_queries_details_histogram_count"
              client_name: "johns-macbook"
              user: ""
            value: [1705312800, "4521"]
          - metric:
              __name__: "adguard_queries_details_histogram_count"
              client_name: "iphone"
              user: ""
            value: [1705312800, "2103"]
          - metric:
              __name__: "adguard_queries_details_histogram_count"
              client_name: "smart-tv"
              user: ""
            value: [1705312800, "890"]
  - url: "http://prometheus.test:9090/api/v1/metadata"
    method: GET
    status: 200
    body:
      status: "success"
      data:
        adguard_queries_details_histogram_count:
          - type: "histogram"
            help: "AdGuard Home DNS query details"
            unit: ""
  - url: "http://grafana.test:3000/api/alertmanager/grafana/api/v2/alerts/groups"
    method: GET
    status: 200
    body: []

rubric: |
  The answer should:
  1. Identify johns-macbook as the top DNS query source
  2. Show a ranking or listing of clients by query volume (johns-macbook > iphone > smart-tv)
  3. Identify clients by their client_name (johns-macbook, iphone, smart-tv)
