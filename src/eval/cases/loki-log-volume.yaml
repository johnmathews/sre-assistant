id: loki-log-volume
description: "Agent should use loki_metric_query to rank hosts by log volume"
question: "Which host produces the most logs? Show me a breakdown of log volume by host."

required_services: [loki]

expected_tools:
  must_call: [loki_metric_query]
  may_call: [loki_list_label_values]
  must_not_call: [prometheus_instant_query]

mocks:
  - url: "http://loki.test:3100/loki/api/v1/query"
    method: GET
    status: 200
    body:
      status: "success"
      data:
        resultType: "vector"
        result:
          - metric:
              hostname: "infra"
            value: [1705312800, "41250"]
          - metric:
              hostname: "media"
            value: [1705312800, "12800"]
          - metric:
              hostname: "jellyfin"
            value: [1705312800, "3420"]
          - metric:
              hostname: "truenas"
            value: [1705312800, "1890"]
  - url: "http://loki.test:3100/loki/api/v1/query_range"
    method: GET
    status: 200
    body:
      status: "success"
      data:
        resultType: "vector"
        result:
          - metric:
              hostname: "infra"
            value: [1705312800, "41250"]
          - metric:
              hostname: "media"
            value: [1705312800, "12800"]
          - metric:
              hostname: "jellyfin"
            value: [1705312800, "3420"]
          - metric:
              hostname: "truenas"
            value: [1705312800, "1890"]
  - url: "http://loki.test:3100/loki/api/v1/label/hostname/values"
    method: GET
    status: 200
    body:
      status: "success"
      data: ["infra", "jellyfin", "media", "truenas"]
  - url: "http://loki.test:3100/ready"
    method: GET
    status: 200
    body: "ready"

rubric: |
  The answer should:
  1. Identify infra as the host producing the most logs
  2. Show a ranking of all hosts by log volume (infra > media > jellyfin > truenas)
  3. Provide context such as noting that infra produces significantly more logs than other hosts
